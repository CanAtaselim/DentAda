@{
    Layout = "~/Views/Shared/_AjaxLayout.cshtml";
}
@section pageLevelInlineScripts {
    <script>
        function formatBytes(bytes,decimals) {
            if(bytes == 0) return '0 Bytes';
            var k = 1024,
                dm = decimals <= 0 ? 0 : decimals || 2,
                sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'],
                i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        Array.prototype.sum = function (prop) {
            var total = 0
            for ( var i = 0, _len = this.length; i < _len; i++ ) {
                total += this[i][prop]
            }
            return total
        }
        var galleryItems = [];
        var map = {};
        jQuery(document).ready(function ()
        {

            var totalFileSizeLimit = 20 * 1024 * 1024;
            var fileSizeLimit = 2 * 1024 * 1024;

            function addArrayFile(files, callback) {
                KTApp.blockPage({
                    overlayColor: '#333',
                    opacity: 0.6,
                    type: 'v2',
                    state: 'success',
                    message: "İşleminiz gerçekleştiriliyor lütfen bekleyiniz..."
                });
                setTimeout(function() {

                    Array.from(files).forEach(file => {
                        var count = 0;
                        if (file.size < fileSizeLimit) {
                            var hasItem = galleryItems.filter(item => (item.name == file.name));
                            if (hasItem.length == 0)
                            {

                                var item = map[file.name] = {
                                    name: file.name,
                                    file: file,
                                    size: file.size
                                }
                                galleryItems.push(item);

                                var avatarDiv = $('<div/>').attr({
                                    'class' : 'kt-avatar kt-avatar--outline'
                                }).appendTo('#galleryContents');

                                var label = $('<label/>').attr({
                                    'class':'kt-avatar__upload btnRemoveImage',
                                    'data-toggle' : 'kt-tooltip',
                                    'data-original-title' :'('+ (formatBytes(file.size)) +') Fotoğrafı Sil ',
                                    'title': '',
                                    'style': 'right:0px; top:0px; width:22px; height:22px',
                                    'data-filename': file.name
                                }).appendTo(avatarDiv);

                                $('<i/>').attr({
                                    'class': 'la la-close'
                                }).appendTo(label);


                                $('<img />').attr({
                                    'src': URL.createObjectURL(file),
                                    'data-toggle' : 'kt-tooltip',
                                    'data-original-title' : formatBytes(file.size),
                                    'class': "img-thumbnail",
                                    'style': 'max-height:100px; ' + (count == 0 ? 'margin:10px 10px 10px 0' : 'margin:10px')
                                }).appendTo(avatarDiv);
                            }
                            count++;
                        }
                    });
                    callback();
                }, 300);
            }
            function unblock() {
                setTimeout(function(){
                        $('[data-toggle="kt-tooltip"]').tooltip();
                        $("#txtFileSize").html("");
                        fileSizeText();
                        KTApp.unblockPage();
                        if (galleryItems.sum("size") > totalFileSizeLimit)
                        {
                            swal.fire("Dikkat", "Seçtiğiniz resimlerin toplam boyutu 20MB'tan fazla", "error");
                        }
                        $("#submit_form")[0].reset()
                }, 300);
            }
            $("#customFile").change(function (event)
            {
                addArrayFile(event.target.files, unblock)
            });

            function fileSizeText() {
                if (galleryItems.sum("size") > totalFileSizeLimit)
                {
                    $("#txtFileSize").removeClass("kt-badge--success");
                    $("#txtFileSize").addClass("kt-badge--danger");
                } else
                {
                    $("#txtFileSize").addClass("kt-badge--success");
                    $("#txtFileSize").removeClass("kt-badge--danger");

                }
                $("#txtFileSize").html("Toplam Boyut " + formatBytes(galleryItems.sum("size")));
            }
            $(document).on("click", '.btnRemoveImage', function () {
                $("[data-toggle='kt-tooltip']").tooltip('hide');
                var that = this;
                $(that).parent("div").remove();
                galleryItems = galleryItems.filter(function (item)
                {
                    return item.name != $(that).data("filename");
                });
                if (galleryItems.length == 0)
                {
                    $("#txtFileSize").hide();
                }
                fileSizeText();
            })

            $(".btnSave").click(function (event)
            {
                event.preventDefault();
                var fileData = new FormData();
                galleryItems.forEach(item => {

                        fileData.append(item.name, item.file);

                });

                $.ajax({
                    type: "POST",
                    url: "@Url.Action("Save", new { area = "Admin", controller = "Gallery" })",
                    contentType: false,
                    processData: false,
                    beforeSend: KTApp.blockPage({
                        overlayColor: '#333',
                        opacity: 0.6,
                        type: 'v2',
                        state: 'success',
                        message: "İşleminiz gerçekleştiriliyor lütfen bekleyiniz..."
                    }),
                    data: fileData,
                    success: function (result)
                    {
                        KTApp.unblockPage();
                        if (result.status == 1)
                        {
                            swal.fire({
                                title: "Başarılı!",
                                text: result.message,
                                type: "success"
                            }).then(function() {
                                reInvokeComponent();
                            });
                        } else
                        {
                            swal.fire({
                                title: "Hata!",
                                text: result.message,
                                type: "error"
                            });
                        }
                    },
                    error: function (err)
                    {
                        KTApp.unblockPage();
                        if (err) { swal.fire("Hata", err, "error"); }
                    }
                });

            });
        });
    </script>
}
@section pageLevelStyles {

}
@section pageLevelInlineStyles {
    <style>
        .kt-avatar .kt-avatar__upload i {
            color: #fd397a;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 2px;
        }

        .kt-avatar .kt-avatar__upload:hover i {
            color: white;
        }

        .kt-avatar .kt-avatar__upload:hover {
            background-color: #fd397a;
        }

        [type="file"] {
            height: 0;
            overflow: hidden;
            width: 0;
        }
    </style>
}
@section pageLevelPlugins {


}
<div class="kt-portlet">
    <div class="kt-portlet__head">
        <div class="kt-portlet__head-label">
            <span class="kt-portlet__head-icon">
                <i class="fa fa-images"></i>
            </span>
            <h3 class="kt-portlet__head-title">
                Galeri
            </h3>
        </div>
        <div class="kt-portlet__head-toolbar">
            <div class="kt-portlet__head-actions">
                <button type="button" class="btn btn-success btn-elevate btn-elevate-air btnSave"><i class="fa fa-save"></i>Kaydet</button>
            </div>
        </div>
    </div>
    <form novalidate id="submit_form" class="horizontal-form" enctype="multipart/form-data">
        <div class="kt-portlet__body">
            <div class="form-group row">
                <div class="col-12">
                    <label class="btn btn-brand btn-elevate btn-elevate-air" for="customFile"><i class="fa fa-upload"></i>Resim Seç</label>
                    <input multiple type="file" name="files" class="custom-file-input" id="customFile" accept="image/png,image/jpg,image/jpeg">
                </div>
            </div>
            <div class="form-group row">
                <div class="col-12">
                    <span id="txtFileSize" class="kt-badge kt-badge--lg kt-badge--inline"></span>
                </div>
            </div>

            <div id="galleryContents"></div>
        </div>
        <div class="kt-portlet__foot">
            <div class="row">
                <div class="col-lg-12">
                    <button type="button" class="btn btn-success btn-elevate btn-elevate-air btnSave"><i class="fa fa-save"></i>Kaydet</button>
                </div>
            </div>
        </div>
    </form>
</div>


